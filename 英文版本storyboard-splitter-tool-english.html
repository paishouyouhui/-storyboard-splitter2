<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Storyboard Panel Splitter Tool</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useRef, useEffect } = React;
        
        // Simplified Lucide React Icons
        const Download = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3"/>
            </svg>
        );
        
        const Plus = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>
            </svg>
        );
        
        const Trash2 = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
            </svg>
        );
        
        const Grid3x3 = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <rect x="3" y="3" width="18" height="18" rx="2"/><line x1="9" y1="3" x2="9" y2="21"/>
                <line x1="15" y1="3" x2="15" y2="21"/><line x1="3" y1="9" x2="21" y2="9"/>
                <line x1="3" y1="15" x2="21" y2="15"/>
            </svg>
        );
        
        const Move = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <polyline points="5 9 2 12 5 15"/><polyline points="9 5 12 2 15 5"/>
                <polyline points="15 19 12 22 9 19"/><polyline points="19 9 22 12 19 15"/>
                <line x1="2" y1="12" x2="22" y2="12"/><line x1="12" y1="2" x2="12" y2="22"/>
            </svg>
        );

        function StoryboardSplitter() {
            const [image, setImage] = useState(null);
            const [horizontalLines, setHorizontalLines] = useState([]);
            const [verticalLines, setVerticalLines] = useState([]);
            const [draggedLine, setDraggedLine] = useState(null);
            const [imageSize, setImageSize] = useState({ width: 0, height: 0 });
            const [showGridInput, setShowGridInput] = useState(false);
            const [gridRows, setGridRows] = useState(2);
            const [gridCols, setGridCols] = useState(2);
            const [isDragging, setIsDragging] = useState(false);
            const [showPanelSelector, setShowPanelSelector] = useState(false);
            const [selectedPanels, setSelectedPanels] = useState(new Set());
            const [autoTrimBlackBorders, setAutoTrimBlackBorders] = useState(true);
            const [lineThickness, setLineThickness] = useState(3);
            const [showLineSettings, setShowLineSettings] = useState(false);
            const containerRef = useRef(null);
            const imageRef = useRef(null);
            const fileInputRef = useRef(null);

            const trimBlackBorders = (canvas, ctx) => {
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const data = imageData.data;
                const threshold = 30;
                
                let top = 0, bottom = canvas.height, left = 0, right = canvas.width;
                
                outer: for (let y = 0; y < canvas.height; y++) {
                    for (let x = 0; x < canvas.width; x++) {
                        const i = (y * canvas.width + x) * 4;
                        const brightness = (data[i] + data[i + 1] + data[i + 2]) / 3;
                        if (brightness > threshold) {
                            top = y;
                            break outer;
                        }
                    }
                }
                
                outer: for (let y = canvas.height - 1; y >= top; y--) {
                    for (let x = 0; x < canvas.width; x++) {
                        const i = (y * canvas.width + x) * 4;
                        const brightness = (data[i] + data[i + 1] + data[i + 2]) / 3;
                        if (brightness > threshold) {
                            bottom = y + 1;
                            break outer;
                        }
                    }
                }
                
                outer: for (let x = 0; x < canvas.width; x++) {
                    for (let y = top; y < bottom; y++) {
                        const i = (y * canvas.width + x) * 4;
                        const brightness = (data[i] + data[i + 1] + data[i + 2]) / 3;
                        if (brightness > threshold) {
                            left = x;
                            break outer;
                        }
                    }
                }
                
                outer: for (let x = canvas.width - 1; x >= left; x--) {
                    for (let y = top; y < bottom; y++) {
                        const i = (y * canvas.width + x) * 4;
                        const brightness = (data[i] + data[i + 1] + data[i + 2]) / 3;
                        if (brightness > threshold) {
                            right = x + 1;
                            break outer;
                        }
                    }
                }
                
                const trimmedWidth = right - left;
                const trimmedHeight = bottom - top;
                
                if (trimmedWidth < canvas.width * 0.1 || trimmedHeight < canvas.height * 0.1) {
                    return { canvas, trimmed: false };
                }
                
                const trimmedCanvas = document.createElement('canvas');
                trimmedCanvas.width = trimmedWidth;
                trimmedCanvas.height = trimmedHeight;
                const trimmedCtx = trimmedCanvas.getContext('2d');
                
                trimmedCtx.drawImage(canvas, left, top, trimmedWidth, trimmedHeight, 0, 0, trimmedWidth, trimmedHeight);
                
                return { canvas: trimmedCanvas, trimmed: true };
            };

            const getPanels = () => {
                const sortedHLines = [0, ...[...horizontalLines].sort((a, b) => a - b), imageSize.height];
                const sortedVLines = [0, ...[...verticalLines].sort((a, b) => a - b), imageSize.width];
                const panels = [];
                
                const halfThickness = Math.floor(lineThickness / 2);
                
                for (let i = 0; i < sortedHLines.length - 1; i++) {
                    for (let j = 0; j < sortedVLines.length - 1; j++) {
                        const startY = i === 0 ? sortedHLines[i] : sortedHLines[i] + halfThickness;
                        const startX = j === 0 ? sortedVLines[j] : sortedVLines[j] + halfThickness;
                        
                        const endY = i === sortedHLines.length - 2 ? sortedHLines[i + 1] : sortedHLines[i + 1] - halfThickness;
                        const endX = j === sortedVLines.length - 2 ? sortedVLines[j + 1] : sortedVLines[j + 1] - halfThickness;
                        
                        const width = endX - startX;
                        const height = endY - startY;
                        
                        if (width > 0 && height > 0) {
                            panels.push({
                                index: panels.length + 1,
                                x: startX,
                                y: startY,
                                width: width,
                                height: height
                            });
                        }
                    }
                }
                
                return panels;
            };

            const getPanelPreviews = () => {
                if (!imageRef.current) return [];
                
                return getPanels().map((panel) => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    canvas.width = 150;
                    canvas.height = 150;
                    
                    const scaleX = 150 / panel.width;
                    const scaleY = 150 / panel.height;
                    const scale = Math.min(scaleX, scaleY);
                    const displayWidth = panel.width * scale;
                    const displayHeight = panel.height * scale;
                    const offsetX = (150 - displayWidth) / 2;
                    const offsetY = (150 - displayHeight) / 2;
                    
                    ctx.fillStyle = '#f3f4f6';
                    ctx.fillRect(0, 0, 150, 150);
                    ctx.drawImage(imageRef.current, 
                        panel.x, panel.y, panel.width, panel.height,
                        offsetX, offsetY, displayWidth, displayHeight
                    );
                    
                    return {
                        ...panel,
                        preview: canvas.toDataURL()
                    };
                });
            };

            const togglePanelSelection = (panelIndex) => {
                console.log('Clicked panel:', panelIndex);
                const newSelected = new Set(selectedPanels);
                if (newSelected.has(panelIndex)) {
                    newSelected.delete(panelIndex);
                } else {
                    newSelected.add(panelIndex);
                }
                setSelectedPanels(newSelected);
                console.log('Current selection:', Array.from(newSelected));
            };

            const selectAllPanels = () => {
                const panels = getPanels();
                setSelectedPanels(new Set(panels.map(p => p.index)));
            };

            const deselectAllPanels = () => {
                setSelectedPanels(new Set());
            };

            const loadImageFile = (file) => {
                if (file && file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        const img = new Image();
                        img.onload = () => {
                            setImage(event.target.result);
                            setImageSize({ width: img.width, height: img.height });
                            setHorizontalLines([]);
                            setVerticalLines([]);
                            setSelectedPanels(new Set());
                        };
                        img.src = event.target.result;
                    };
                    reader.readAsDataURL(file);
                }
            };

            const handleImageUpload = (e) => {
                const file = e.target.files[0];
                loadImageFile(file);
                e.target.value = '';
            };

            const handleChangeImage = () => {
                if (fileInputRef.current) {
                    fileInputRef.current.click();
                }
            };

            const handleDragOver = (e) => {
                e.preventDefault();
                e.stopPropagation();
                setIsDragging(true);
            };

            const handleDragLeave = (e) => {
                e.preventDefault();
                e.stopPropagation();
                setIsDragging(false);
            };

            const handleDrop = (e) => {
                e.preventDefault();
                e.stopPropagation();
                setIsDragging(false);
                
                const files = e.dataTransfer.files;
                if (files && files.length > 0) {
                    loadImageFile(files[0]);
                }
            };

            const addHorizontalLine = () => {
                const newY = imageSize.height / (horizontalLines.length + 2);
                setHorizontalLines([...horizontalLines, newY * (horizontalLines.length + 1)]);
            };

            const addVerticalLine = () => {
                const newX = imageSize.width / (verticalLines.length + 2);
                setVerticalLines([...verticalLines, newX * (verticalLines.length + 1)]);
            };

            const autoGridSplit = (rows, cols) => {
                const hLines = [];
                const vLines = [];
                
                for (let i = 1; i < rows; i++) {
                    hLines.push((imageSize.height / rows) * i);
                }
                
                for (let i = 1; i < cols; i++) {
                    vLines.push((imageSize.width / cols) * i);
                }
                
                setHorizontalLines(hLines);
                setVerticalLines(vLines);
            };

            const applyCustomGrid = () => {
                autoGridSplit(gridRows, gridCols);
                setShowGridInput(false);
            };

            const handleMouseDown = (type, index) => {
                setDraggedLine({ type, index });
            };

            const handleMouseMove = (e) => {
                if (!draggedLine || !containerRef.current) return;

                const rect = containerRef.current.getBoundingClientRect();
                const scaleX = imageSize.width / rect.width;
                const scaleY = imageSize.height / rect.height;

                if (draggedLine.type === 'horizontal') {
                    const y = (e.clientY - rect.top) * scaleY;
                    const newLines = [...horizontalLines];
                    newLines[draggedLine.index] = Math.max(0, Math.min(imageSize.height, y));
                    setHorizontalLines(newLines);
                } else {
                    const x = (e.clientX - rect.left) * scaleX;
                    const newLines = [...verticalLines];
                    newLines[draggedLine.index] = Math.max(0, Math.min(imageSize.width, x));
                    setVerticalLines(newLines);
                }
            };

            const handleMouseUp = () => {
                setDraggedLine(null);
            };

            const removeLine = (type, index) => {
                if (type === 'horizontal') {
                    setHorizontalLines(horizontalLines.filter((_, i) => i !== index));
                } else {
                    setVerticalLines(verticalLines.filter((_, i) => i !== index));
                }
            };

            const exportPanels = async (selectedOnly = false) => {
                console.log('=== Starting export ===');
                console.log('selectedOnly:', selectedOnly);
                console.log('Selected panels:', Array.from(selectedPanels));
                
                if (!image) {
                    alert('No image loaded!');
                    return;
                }

                const panels = getPanels();
                console.log('All panels:', panels);
                
                const panelsToExport = selectedOnly 
                    ? panels.filter(p => selectedPanels.has(p.index))
                    : panels;
                
                console.log('Panels to export:', panelsToExport);

                if (panelsToExport.length === 0) {
                    alert('Please select panels to export first!');
                    return;
                }

                if (!confirm(`About to download ${panelsToExport.length}  panel(s)Êñá‰ª∂Âà∞ÊµèËßàÂô®ÈªòËÆ§‰∏ãËΩΩÊñá‰ª∂Â§πÔºåÊòØÂê¶ÁªßÁª≠Ôºü`)) {
                    return;
                }

                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const img = new Image();
                
                img.crossOrigin = 'anonymous';
                
                img.onload = async () => {
                    let successCount = 0;
                    
                    for (const panel of panelsToExport) {
                        canvas.width = panel.width;
                        canvas.height = panel.height;
                        
                        ctx.clearRect(0, 0, panel.width, panel.height);
                        ctx.drawImage(img, panel.x, panel.y, panel.width, panel.height, 0, 0, panel.width, panel.height);
                        
                        let finalCanvas = canvas;
                        if (autoTrimBlackBorders) {
                            const result = trimBlackBorders(canvas, ctx);
                            finalCanvas = result.canvas;
                        }
                        
                        await new Promise((resolve) => {
                            finalCanvas.toBlob((blob) => {
                                const url = URL.createObjectURL(blob);
                                const link = document.createElement('a');
                                link.download = `panel_${panel.index}.png`;
                                link.href = url;
                                link.style.display = 'none';
                                document.body.appendChild(link);
                                link.click();
                                document.body.removeChild(link);
                                
                                setTimeout(() => {
                                    URL.revokeObjectURL(url);
                                    successCount++;
                                    resolve();
                                }, 100);
                            }, 'image/png');
                        });
                        
                        await new Promise(resolve => setTimeout(resolve, 200));
                    }
                    
                    alert(`Successfully exported ${successCount}  panel(s)Âà∞ÈªòËÆ§‰∏ãËΩΩÊñá‰ª∂Â§πÔºÅ${autoTrimBlackBorders ? '(Â∑≤Auto-trim black borders)' : ''}`);
                    if (selectedOnly) {
                        setShowPanelSelector(false);
                        setSelectedPanels(new Set());
                    }
                };
                
                img.onerror = () => {
                    alert('Export failed, please re-upload the image and try again');
                };
                
                img.src = image;
            };

            const handleExportClick = () => {
                console.log('üî¥ ÂØºÂá∫ÊåâÈíÆË¢´ÁÇπÂáªÔºÅ');
                console.log('selectedPanels.size:', selectedPanels.size);
                console.log('selectedPanelsÂÜÖÂÆπ:', Array.from(selectedPanels));
                
                if (selectedPanels.size === 0) {
                    alert('Please select panels first! Current selection count: 0');
                    return;
                }
                
                exportPanels(true);
            };

            useEffect(() => {
                if (draggedLine) {
                    window.addEventListener('mousemove', handleMouseMove);
                    window.addEventListener('mouseup', handleMouseUp);
                    return () => {
                        window.removeEventListener('mousemove', handleMouseMove);
                        window.removeEventListener('mouseup', handleMouseUp);
                    };
                }
            }, [draggedLine, horizontalLines, verticalLines]);

            return (
                <div className="min-h-screen bg-gradient-to-br from-purple-50 to-blue-50 p-8">
                    <div className="max-w-7xl mx-auto">
                        <div className="bg-white rounded-2xl shadow-xl p-8">
                            <h1 className="text-4xl font-bold text-gray-800 mb-2 flex items-center gap-3">
                                <Grid3x3 size={40} className="text-purple-600" />
                                Storyboard Panel Splitter Tool
                            </h1>
                            <p className="text-gray-600 mb-4">Upload your storyboard, adjust split lines freely, and export individual panels</p>

                            {image && (
                                <div className="bg-yellow-50 border-2 border-yellow-300 rounded-lg p-4 mb-4">
                                    <h3 className="font-bold text-yellow-900 mb-2">üîç Live Status</h3>
                                    <div className="grid grid-cols-2 gap-2 text-sm">
                                        <div><strong>Image:</strong> ‚úÖ</div>
                                        <div><strong>Total Panels:</strong> {getPanels().length}</div>
                                        <div><strong>Selected:</strong> {selectedPanels.size}</div>
                                        <div><strong>Numbers:</strong> [{Array.from(selectedPanels).join(', ') || 'None'}]</div>
                                    </div>
                                </div>
                            )}

                            {!image ? (
                                <div 
                                    className={`border-4 border-dashed rounded-xl p-16 text-center transition-all ${
                                        isDragging ? 'border-purple-500 bg-purple-100' : 'border-purple-300 bg-white'
                                    }`}
                                    onDragOver={handleDragOver}
                                    onDragLeave={handleDragLeave}
                                    onDrop={handleDrop}
                                >
                                    <input
                                        type="file"
                                        accept="image/*"
                                        onChange={handleImageUpload}
                                        className="hidden"
                                        id="image-upload"
                                        ref={fileInputRef}
                                    />
                                    <label htmlFor="image-upload" className="cursor-pointer flex flex-col items-center gap-4">
                                        <div className={`w-20 h-20 rounded-full flex items-center justify-center ${isDragging ? 'bg-purple-200' : 'bg-purple-100'}`}>
                                            <Plus size={40} className="text-purple-600" />
                                        </div>
                                        <div>
                                            <p className="text-xl font-semibold text-gray-700">
                                                {isDragging ? 'Release to upload image' : 'Click or drag to upload storyboard image'}
                                            </p>
                                            <p className="text-gray-500 mt-2">ÊîØÊåÅ JPG, PNG, GIF Ê†ºÂºè</p>
                                        </div>
                                    </label>
                                </div>
                            ) : (
                                <div className="space-y-6">
                                    <input type="file" accept="image/*" onChange={handleImageUpload} className="hidden" id="image-upload" ref={fileInputRef} />
                                    
                                    <div className="flex flex-wrap gap-3 bg-gray-50 p-4 rounded-xl">
                                        <button onClick={addHorizontalLine} className="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 flex items-center gap-2">
                                            <Plus size={18} /> Ê∑ªÂä†Ê∞¥Âπ≥Á∫ø
                                        </button>
                                        <button onClick={addVerticalLine} className="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 flex items-center gap-2">
                                            <Plus size={18} /> Ê∑ªÂä†ÂûÇÁõ¥Á∫ø
                                        </button>
                                        <button onClick={() => autoGridSplit(2, 2)} className="px-4 py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600 flex items-center gap-2">
                                            <Grid3x3 size={18} /> 2√ó2 ÁΩëÊ†º
                                        </button>
                                        <button onClick={() => autoGridSplit(3, 3)} className="px-4 py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600 flex items-center gap-2">
                                            <Grid3x3 size={18} /> 3√ó3 ÁΩëÊ†º
                                        </button>
                                        <button onClick={() => autoGridSplit(2, 3)} className="px-4 py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600 flex items-center gap-2">
                                            <Grid3x3 size={18} /> 2√ó3 ÁΩëÊ†º
                                        </button>
                                        <button onClick={() => setShowGridInput(!showGridInput)} className="px-4 py-2 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600 flex items-center gap-2">
                                            <Grid3x3 size={18} /> Ëá™ÂÆö‰πâÁΩëÊ†º
                                        </button>
                                        <label className="flex items-center gap-2 px-4 py-2 bg-yellow-50 border-2 border-yellow-300 rounded-lg cursor-pointer hover:bg-yellow-100">
                                            <input type="checkbox" checked={autoTrimBlackBorders} onChange={(e) => setAutoTrimBlackBorders(e.target.checked)} className="w-4 h-4" />
                                            <span className="text-sm font-medium text-yellow-900">Auto-trim black borders</span>
                                        </label>
                                        <button onClick={() => setShowLineSettings(!showLineSettings)} className="px-4 py-2 bg-pink-500 text-white rounded-lg hover:bg-pink-600 flex items-center gap-2">
                                            <Grid3x3 size={18} /> Á∫øÊù°ËÆæÁΩÆ
                                        </button>
                                        <button onClick={() => exportPanels(false)} className="px-4 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600 flex items-center gap-2 ml-auto">
                                            <Download size={18} /> ÂØºÂá∫ÊâÄÊúâÂàÜÈïú
                                        </button>
                                        <button onClick={() => setShowPanelSelector(!showPanelSelector)} className="px-4 py-2 bg-teal-500 text-white rounded-lg hover:bg-teal-600 flex items-center gap-2">
                                            <Download size={18} /> ÈÄâÊã©‰∏ãËΩΩ
                                        </button>
                                        <button onClick={handleChangeImage} className="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">
                                            Replace Image
                                        </button>
                                    </div>

                                    {showLineSettings && (
                                        <div className="bg-pink-50 border-2 border-pink-200 rounded-xl p-4">
                                            <h3 className="font-semibold text-pink-900 mb-3">Á∫øÊù°ÂéöÂ∫¶ËÆæÁΩÆ</h3>
                                            <div className="flex items-center gap-4 flex-wrap">
                                                <div className="flex items-center gap-3 flex-1 min-w-[250px]">
                                                    <label className="text-sm font-medium text-pink-800">Á∫øÊù°ÂéöÂ∫¶Ôºö</label>
                                                    <input type="range" min="1" max="20" value={lineThickness} onChange={(e) => setLineThickness(parseInt(e.target.value))} className="flex-1" />
                                                    <span className="text-sm font-bold text-pink-700 w-12 text-center">{lineThickness}px</span>
                                                </div>
                                                <div className="flex gap-2">
                                                    {[1, 3, 6, 10, 15].map(val => (
                                                        <button key={val} onClick={() => setLineThickness(val)} className={`px-3 py-1 text-sm rounded ${lineThickness === val ? 'bg-pink-600 text-white' : 'bg-pink-200 text-pink-700'}`}>
                                                            {val === 1 ? 'ÁªÜ' : val === 3 ? '‰∏≠' : val === 6 ? 'Á≤ó' : val === 10 ? 'Ë∂ÖÁ≤ó' : 'ÁâπÁ≤ó'}
                                                        </button>
                                                    ))}
                                                </div>
                                                <button onClick={() => setShowLineSettings(false)} className="px-4 py-2 bg-gray-400 text-white rounded-lg">Close</button>
                                            </div>
                                        </div>
                                    )}

                                    {showGridInput && (
                                        <div className="bg-indigo-50 border-2 border-indigo-200 rounded-xl p-4">
                                            <h3 className="font-semibold text-indigo-900 mb-3">Ëá™ÂÆö‰πâÁΩëÊ†ºËÆæÁΩÆ</h3>
                                            <div className="flex items-center gap-4 flex-wrap">
                                                <div className="flex items-center gap-2">
                                                    <label className="text-sm font-medium text-indigo-800">RowsÔºö</label>
                                                    <input type="number" min="1" max="10" value={gridRows} onChange={(e) => setGridRows(Math.max(1, parseInt(e.target.value) || 1))} className="w-20 px-3 py-2 border-2 border-indigo-300 rounded-lg" />
                                                </div>
                                                <div className="flex items-center gap-2">
                                                    <label className="text-sm font-medium text-indigo-800">ColumnsÔºö</label>
                                                    <input type="number" min="1" max="10" value={gridCols} onChange={(e) => setGridCols(Math.max(1, parseInt(e.target.value) || 1))} className="w-20 px-3 py-2 border-2 border-indigo-300 rounded-lg" />
                                                </div>
                                                <button onClick={applyCustomGrid} className="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-medium">
                                                    Â∫îÁî® {gridRows}√ó{gridCols} ÁΩëÊ†º
                                                </button>
                                                <button onClick={() => setShowGridInput(false)} className="px-4 py-2 bg-gray-400 text-white rounded-lg">ÂèñÊ∂à</button>
                                            </div>
                                        </div>
                                    )}

                                    {showPanelSelector && (
                                        <div className="bg-teal-50 border-2 border-teal-200 rounded-xl p-4">
                                            <div className="flex items-center justify-between mb-3">
                                                <h3 className="font-semibold text-teal-900">ÈÄâÊã©Ë¶ÅÂØºÂá∫ÁöÑÂàÜÈïú</h3>
                                                <div className="flex gap-2">
                                                    <button onClick={selectAllPanels} className="px-3 py-1 text-sm bg-teal-600 text-white rounded hover:bg-teal-700">Select All</button>
                                                    <button onClick={deselectAllPanels} className="px-3 py-1 text-sm bg-gray-400 text-white rounded hover:bg-gray-500">ÂèñÊ∂àSelect All</button>
                                                </div>
                                            </div>
                                            <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-3 mb-3">
                                                {getPanelPreviews().map((panel) => (
                                                    <button
                                                        key={panel.index}
                                                        onClick={() => togglePanelSelection(panel.index)}
                                                        className={`relative rounded-lg border-4 overflow-hidden transition-all ${
                                                            selectedPanels.has(panel.index) ? 'border-teal-600 shadow-lg scale-95' : 'border-teal-300 hover:border-teal-500'
                                                        }`}
                                                    >
                                                        <div className="aspect-square bg-gray-100">
                                                            <img src={panel.preview} alt={`Panel ${panel.index}`} className="w-full h-full object-contain" />
                                                        </div>
                                                        <div className={`absolute top-1 right-1 w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm ${
                                                            selectedPanels.has(panel.index) ? 'bg-teal-600 text-white' : 'bg-white text-teal-700 border-2 border-teal-300'
                                                        }`}>
                                                            {panel.index}
                                                        </div>
                                                        {selectedPanels.has(panel.index) && (
                                                            <div className="absolute inset-0 bg-teal-500 bg-opacity-20 flex items-center justify-center">
                                                                <div className="w-12 h-12 rounded-full bg-teal-600 flex items-center justify-center">
                                                                    <svg className="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={3} d="M5 13l4 4L19 7" />
                                                                    </svg>
                                                                </div>
                                                            </div>
                                                        )}
                                                    </button>
                                                ))}
                                            </div>
                                            <div className="flex items-center justify-between gap-2 flex-wrap">
                                                <div className="text-sm text-teal-700 font-bold">
                                                    {selectedPanels.size > 0 ? `‚úì Selected ${selectedPanels.size}  panel(s)` : '‚ùå Please select panels to export'}
                                                    <div className="text-xs mt-1 font-normal">Â∑≤ÈÄâNumbers: [{Array.from(selectedPanels).join(', ')}]</div>
                                                </div>
                                                <div className="flex gap-2">
                                                    <button
                                                        onClick={handleExportClick}
                                                        className={`px-4 py-2 rounded-lg font-medium flex items-center gap-2 ${
                                                            selectedPanels.size === 0 ? 'bg-gray-300 text-gray-500' : 'bg-teal-600 text-white hover:bg-teal-700'
                                                        }`}
                                                    >
                                                        <Download size={18} />
                                                        Export Selected ({selectedPanels.size})
                                                    </button>
                                                    <button onClick={() => setShowPanelSelector(false)} className="px-4 py-2 bg-gray-400 text-white rounded-lg hover:bg-gray-500">
                                                        Close
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    )}

                                    <div ref={containerRef} className="relative inline-block max-w-full border-2 border-gray-200 rounded-lg overflow-hidden">
                                        <img ref={imageRef} src={image} alt="Storyboard" className="max-w-full h-auto block" draggable={false} />

                                        {horizontalLines.map((y, index) => (
                                            <div
                                                key={`h-${index}`}
                                                style={{
                                                    position: 'absolute',
                                                    top: `${(y / imageSize.height) * 100}%`,
                                                    left: 0,
                                                    right: 0,
                                                    height: `${lineThickness}px`,
                                                    backgroundColor: 'rgba(239, 68, 68, 0.8)',
                                                    cursor: 'ns-resize',
                                                    zIndex: 10,
                                                }}
                                                onMouseDown={() => handleMouseDown('horizontal', index)}
                                            >
                                                <div className="absolute -top-5 right-2">
                                                    <button onClick={(e) => { e.stopPropagation(); removeLine('horizontal', index); }} className="bg-red-500 text-white rounded p-1 hover:bg-red-600">
                                                        <Trash2 size={12} />
                                                    </button>
                                                </div>
                                                <div className="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-red-500 text-white text-xs px-2 py-1 rounded pointer-events-none">
                                                    <Move size={12} />
                                                </div>
                                            </div>
                                        ))}

                                        {verticalLines.map((x, index) => (
                                            <div
                                                key={`v-${index}`}
                                                style={{
                                                    position: 'absolute',
                                                    left: `${(x / imageSize.width) * 100}%`,
                                                    top: 0,
                                                    bottom: 0,
                                                    width: `${lineThickness}px`,
                                                    backgroundColor: 'rgba(59, 130, 246, 0.8)',
                                                    cursor: 'ew-resize',
                                                    zIndex: 10,
                                                }}
                                                onMouseDown={() => handleMouseDown('vertical', index)}
                                            >
                                                <div className="absolute -left-5 top-2">
                                                    <button onClick={(e) => { e.stopPropagation(); removeLine('vertical', index); }} className="bg-blue-500 text-white rounded p-1 hover:bg-blue-600">
                                                        <Trash2 size={12} />
                                                    </button>
                                                </div>
                                                <div className="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-blue-500 text-white text-xs px-2 py-1 rounded pointer-events-none rotate-90">
                                                    <Move size={12} />
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        ReactDOM.render(<StoryboardSplitter />, document.getElementById('root'));
    </script>
</body>
</html>
